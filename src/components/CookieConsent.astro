---
// Cookie Consent with Google Tag Manager integration
// Using vanilla-cookieconsent library
---

<script>
  import "vanilla-cookieconsent/dist/cookieconsent.css";
  import * as CookieConsent from "vanilla-cookieconsent";

  // Extend Window interface for GTM dataLayer
  declare global {
    interface Window {
      dataLayer: unknown[];
    }
  }

  // Initialize Cookie Consent
  CookieConsent.run({
    // Disable page scripts by default
    disablePageInteraction: false,

    // Cookie settings
    cookie: {
      name: "cc_cookie",
      domain: window.location.hostname,
      path: "/",
      sameSite: "Lax",
      expiresAfterDays: 365,
    },

    // GUI options
    guiOptions: {
      consentModal: {
        layout: "box inline",
        position: "bottom right",
        equalWeightButtons: true,
        flipButtons: false,
      },
      preferencesModal: {
        layout: "box",
        position: "right",
        equalWeightButtons: true,
        flipButtons: false,
      },
    },

    // Categories of cookies
    categories: {
      necessary: {
        enabled: true,
        readOnly: true,
      },
      analytics: {
        enabled: false,
        readOnly: false,
        autoClear: {
          cookies: [
            {
              name: /^(_ga|_gid)/,
            },
          ],
        },
      },
      marketing: {
        enabled: false,
        readOnly: false,
        autoClear: {
          cookies: [
            {
              name: /^(_fbp|_gcl)/,
            },
          ],
        },
      },
    },

    // Language configuration
    language: {
      default: "en",
      translations: {
        en: {
          consentModal: {
            title: "We use cookies",
            description:
              'We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic. By clicking "Accept all", you consent to our use of cookies. <a href="' +
              window.location.origin +
              '/legal/privacy">Privacy Policy</a>',
            acceptAllBtn: "Accept all",
            acceptNecessaryBtn: "Reject all",
            showPreferencesBtn: "Manage preferences",
            footer: '<a href="/legal/privacy">Privacy Policy</a> | <a href="/legal/terms">Terms of Service</a>',
          },
          preferencesModal: {
            title: "Cookie Preferences",
            acceptAllBtn: "Accept all",
            acceptNecessaryBtn: "Reject all",
            savePreferencesBtn: "Save preferences",
            closeIconLabel: "Close",
            serviceCounterLabel: "Service|Services",
            sections: [
              {
                title: "Cookie Usage",
                description:
                  "We use cookies to enhance your browsing experience and analyze our traffic. You can choose which categories of cookies you want to allow.",
              },
              {
                title: "Strictly Necessary Cookies <span class=\"pm__badge\">Always Enabled</span>",
                description:
                  "These cookies are essential for the website to function properly. They enable basic functions like page navigation and access to secure areas. The website cannot function properly without these cookies.",
                linkedCategory: "necessary",
              },
              {
                title: "Analytics Cookies",
                description:
                  "These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our website and provide better user experience.",
                linkedCategory: "analytics",
                cookieTable: {
                  headers: {
                    name: "Cookie",
                    domain: "Domain",
                    description: "Description",
                    expiration: "Expiration",
                  },
                  body: [
                    {
                      name: "_ga",
                      domain: window.location.hostname,
                      description: "Google Analytics - Used to distinguish users",
                      expiration: "2 years",
                    },
                    {
                      name: "_gid",
                      domain: window.location.hostname,
                      description: "Google Analytics - Used to distinguish users",
                      expiration: "24 hours",
                    },
                  ],
                },
              },
              {
                title: "Marketing Cookies",
                description:
                  "These cookies are used to deliver advertisements more relevant to you and your interests. They are also used to limit the number of times you see an advertisement and help measure the effectiveness of advertising campaigns.",
                linkedCategory: "marketing",
              },
              {
                title: "More information",
                description:
                  'For more information about our privacy practices, please visit our <a href="/legal/privacy">Privacy Policy</a>. If you have any questions, please <a href="/contact">contact us</a>.',
              },
            ],
          },
        },
      },
    },

    // Callback functions
    onChange: ({ changedCategories }) => {
      // Handle analytics consent
      if (changedCategories.includes("analytics")) {
        if (CookieConsent.acceptedCategory("analytics")) {
          console.info("Analytics cookies enabled");
          // Initialize Google Analytics/GTM
          loadGoogleTagManager();
        } else {
          console.info("Analytics cookies disabled");
        }
      }

      // Handle marketing consent
      if (changedCategories.includes("marketing")) {
        if (CookieConsent.acceptedCategory("marketing")) {
          console.info("Marketing cookies enabled");
        } else {
          console.info("Marketing cookies disabled");
        }
      }
    },

    onFirstConsent: () => {
      console.info("First consent saved");
      
      // Load GTM if analytics accepted
      if (CookieConsent.acceptedCategory("analytics")) {
        loadGoogleTagManager();
      }
    },

    onConsent: () => {
      console.info("Consent updated");
    },
  });

  // Function to load Google Tag Manager
  function loadGoogleTagManager() {
    // Get GTM ID from environment or meta tag
    const gtmId = document.querySelector('meta[name="gtm-id"]')?.getAttribute("content");
    
    if (!gtmId) {
      console.warn("GTM ID not found");
      return;
    }

    // Check if GTM is already loaded
    if (window.dataLayer) {
      console.info("GTM already loaded");
      return;
    }

    // Initialize dataLayer
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      "gtm.start": new Date().getTime(),
      event: "gtm.js",
    });

    // Load GTM script
    const script = document.createElement("script");
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtm.js?id=${gtmId}`;
    document.head.appendChild(script);

    console.info("Google Tag Manager loaded");
  }

  // Show preferences modal on button click
  document.addEventListener("DOMContentLoaded", () => {
    const manageCookiesBtn = document.getElementById("manage-cookies-btn");
    if (manageCookiesBtn) {
      manageCookiesBtn.addEventListener("click", () => {
        CookieConsent.showPreferences();
      });
    }
  });
</script>

<!-- GTM noscript fallback -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX"
    height="0"
    width="0"
    style="display:none;visibility:hidden"></iframe>
</noscript>

<style is:global>
  /* Cookie Consent customization */
  :root {
    --cc-bg: hsl(var(--background));
    --cc-text: hsl(var(--foreground));
    --cc-btn-primary-bg: hsl(var(--primary));
    --cc-btn-primary-text: hsl(var(--primary-foreground));
    --cc-btn-primary-hover-bg: hsl(var(--primary) / 0.9);
    --cc-btn-secondary-bg: hsl(var(--secondary));
    --cc-btn-secondary-text: hsl(var(--secondary-foreground));
    --cc-btn-secondary-hover-bg: hsl(var(--secondary) / 0.8);
    --cc-separator-border-color: hsl(var(--border));
    --cc-toggle-on-bg: hsl(var(--primary));
    --cc-toggle-off-bg: hsl(var(--muted));
    --cc-cookie-category-block-bg: hsl(var(--muted) / 0.3);
    --cc-overlay-bg: rgba(0, 0, 0, 0.6);
    --cc-webkit-scrollbar-bg: hsl(var(--muted));
    --cc-webkit-scrollbar-hover-bg: hsl(var(--muted-foreground));
  }

  /* Dark mode adjustments */
  [data-theme="dark"] {
    --cc-bg: hsl(var(--background));
    --cc-text: hsl(var(--foreground));
  }

  /* Custom styling */
  #cc-main .cm {
    border-radius: var(--radius);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  #cc-main .cm__footer {
    border-top: 1px solid var(--cc-separator-border-color);
  }

  #cc-main .pm {
    border-radius: var(--radius);
  }

  #cc-main .section__toggle {
    border-radius: var(--radius);
  }
</style>
